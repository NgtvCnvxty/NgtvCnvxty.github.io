<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SD Capital Systems</title>
    <link rel="stylesheet" href="styles.css?v=20250929GOC">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body class="landing-page">
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-container">
            <a href="index.html" class="logo" aria-current="page">SD Capital Systems</a>
            <ul class="nav-links">
                <li><a href="solutions.html">Solutions</a></li>
                <li><a href="markets.html">Markets</a></li>
                <li><a href="learn.html">Learn</a></li>
                <li><a href="company.html">Company</a></li>
                <li><a href="letters.html">Letters</a></li>
            </ul>
        </div>
    </nav>
    
    <!-- Landing Content -->
    <div class="landing-wrapper">
        <div class="landing-content">
            <div class="hero-text">
                <div class="company-name">Canada's Marketplace for CAD Bonds, Convertibles and Preferred Shares.</div>
                <p class="tagline">Single name fixed income securities from 30+ issuers including Government of Canada Bonds, Inflation-Linked Bonds, Provincial Bonds, Corporate Bonds, Convertible Bonds and Preferred Shares.</p>
            </div>
            <div class="signup-form">
                <input type="email" class="signup-input" placeholder="Phone/Email" />
                <button class="signup-button">Receive Updates</button>
            </div>
        </div>
        
        <!-- Bond Data Panel -->
        <div class="bond-panel">
            <h2>Government of Canada Yield Curve</h2>
            <p id="data-date" class="data-date" style="font-size: 14px; color: #666; margin-top: -10px; margin-bottom: 20px;"></p>
            <div id="loading-state" class="loading-state">
                <div class="loading-spinner"></div>
                <p>Loading market data...</p>
            </div>
            <table class="bond-table" id="bond-table" style="display: none;">
                <thead>
                    <tr id="table-headers">
                        <!-- Headers will be populated from Excel -->
                    </tr>
                </thead>
                <tbody id="bond-data">
                    <!-- Bond data will be populated from Excel -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- SheetJS Library for Excel Reading -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    
    <!-- Bond Data Script -->
    <script>
        // Load and display bond data from Excel file
        async function loadBondData() {
            try {
                // Fetch the Excel file
                const response = await fetch('MarketData/GOC.xlsx?v=' + Date.now());
                const arrayBuffer = await response.arrayBuffer();
                
                // Parse the Excel file with proper options
                const workbook = XLSX.read(arrayBuffer, {type: 'array'});
                const bondsSheet = workbook.Sheets['Bonds'];
                
                if (!bondsSheet) {
                    throw new Error('Bonds sheet not found');
                }
                
                // Get all data from Bonds sheet
                const allData = XLSX.utils.sheet_to_json(bondsSheet, {
                    header: 1,
                    defval: ''
                });
                
                if (allData.length === 0) {
                    throw new Error('No data found in Bonds sheet');
                }
                
                // Find the latest date row (column A has dates)
                let latestDate = null;
                let latestRowIndex = -1;
                
                for (let i = 1; i < allData.length; i++) { // Start from 1 to skip headers
                    const dateValue = allData[i][0]; // Column A
                    if (dateValue) {
                        let date;
                        if (dateValue instanceof Date) {
                            date = dateValue;
                        } else if (typeof dateValue === 'number') {
                            // Excel serial date
                            date = new Date((dateValue - 25569) * 86400 * 1000);
                        } else {
                            date = new Date(dateValue);
                        }
                        
                        if (!isNaN(date.getTime()) && (!latestDate || date > latestDate)) {
                            latestDate = date;
                            latestRowIndex = i;
                        }
                    }
                }
                
                if (latestRowIndex === -1) {
                    throw new Error('No valid date found');
                }
                
                // Update date display
                const dateElement = document.getElementById('data-date');
                if (dateElement && latestDate) {
                    dateElement.textContent = `(as of ${latestDate.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: '2-digit', 
                        year: 'numeric' 
                    })})`;
                }
                
                // Extract data for all 7 tenors from the latest date row
                const tenorOrder = ['2', '3', '5', '7', '10', '30', 'RRB'];
                const headers = ['Tenor (yrs)', 'Coupon', 'Maturity', 'YTM', 'Price'];
                const bondData = [];
                
                // Find all rows with the latest date
                for (let i = 1; i < allData.length; i++) {
                    const rowDate = allData[i][0];
                    let date;
                    if (rowDate instanceof Date) {
                        date = rowDate;
                    } else if (typeof rowDate === 'number') {
                        date = new Date((rowDate - 25569) * 86400 * 1000);
                    } else {
                        date = new Date(rowDate);
                    }
                    
                    // Check if this row has the latest date
                    if (!isNaN(date.getTime()) && Math.abs(date.getTime() - latestDate.getTime()) < 24 * 60 * 60 * 1000) {
                        const tenor = String(allData[i][1]); // Column B
                        const coupon = allData[i][2]; // Column C
                        const maturity = allData[i][3]; // Column D
                        const ytm = allData[i][4]; // Column E
                        const price = allData[i][5]; // Column F
                        
                        bondData.push({
                            tenor: tenor,
                            coupon: coupon,
                            maturity: maturity,
                            ytm: ytm,
                            price: price
                        });
                    }
                }
                
                // Sort data by tenor order
                bondData.sort((a, b) => {
                    const aIndex = tenorOrder.indexOf(String(a.tenor));
                    const bIndex = tenorOrder.indexOf(String(b.tenor));
                    return (aIndex === -1 ? 999 : aIndex) - (bIndex === -1 ? 999 : bIndex);
                });
                
                populateTable(headers, bondData);
                
            } catch (error) {
                console.error('Error loading bond data:', error);
                // Fallback to sample data
                loadSampleData();
            }
        }
        
        function formatBondData(bondRow) {
            const formatted = [];
            
            // Column 0: Tenor (yrs) - display as is
            formatted.push(bondRow.tenor || '');
            
            // Column 1: Coupon - show as percentage (already in percentage form in Excel)
            const coupon = parseFloat(bondRow.coupon);
            formatted.push(Number.isFinite(coupon) ? `${coupon.toFixed(3)}%` : bondRow.coupon || '');
            
            // Column 2: Maturity - format as MMM DD, YYYY
            let maturityFormatted = '';
            if (bondRow.maturity) {
                let date;
                if (bondRow.maturity instanceof Date) {
                    date = bondRow.maturity;
                } else if (typeof bondRow.maturity === 'number') {
                    // Excel serial date
                    date = new Date((bondRow.maturity - 25569) * 86400 * 1000);
                } else {
                    date = new Date(bondRow.maturity);
                }
                
                if (!isNaN(date.getTime())) {
                    maturityFormatted = date.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: '2-digit', 
                        year: 'numeric' 
                    });
                } else {
                    maturityFormatted = bondRow.maturity;
                }
            }
            formatted.push(maturityFormatted);
            
            // Column 3: YTM - format as percentage with 2 decimal places
            const ytm = parseFloat(bondRow.ytm);
            formatted.push(Number.isFinite(ytm) ? `${ytm.toFixed(2)}%` : bondRow.ytm || '');
            
            // Column 4: Price - format as currency with dollar sign and 2 decimals
            const price = parseFloat(bondRow.price);
            formatted.push(Number.isFinite(price) ? `$${price.toFixed(2)}` : bondRow.price || '');
            
            return formatted;
        }
        
        function populateTable(headers, bondData) {
            // Hide loading state and show table
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('bond-table').style.display = 'table';
            
            // Populate headers
            const headerRow = document.getElementById('table-headers');
            headerRow.innerHTML = headers.map(header => `<th>${header}</th>`).join('');
            
            // Populate data using new formatting function
            const tbody = document.getElementById('bond-data');
            tbody.innerHTML = bondData.map(bondRow => {
                const formattedData = formatBondData(bondRow);
                return `<tr>${formattedData.map(cell => `<td>${cell}</td>`).join('')}</tr>`;
            }).join('');
        }
        
        function loadSampleData() {
            // Fallback sample data with new structure
            const headers = ['Tenor (yrs)', 'Coupon', 'Maturity', 'YTM', 'Price'];
            const sampleBondData = [
                { tenor: '2', coupon: 4.25, maturity: 'Jan 27, 2027', ytm: 4.30, price: 99.80 },
                { tenor: '3', coupon: 4.10, maturity: 'Jan 27, 2028', ytm: 4.05, price: 100.15 },
                { tenor: '5', coupon: 3.95, maturity: 'Jan 27, 2030', ytm: 3.85, price: 101.20 },
                { tenor: '7', coupon: 3.85, maturity: 'Jan 27, 2032', ytm: 3.75, price: 102.05 },
                { tenor: '10', coupon: 3.75, maturity: 'Jan 27, 2035', ytm: 3.65, price: 103.10 },
                { tenor: '30', coupon: 3.90, maturity: 'Jan 27, 2055', ytm: 3.80, price: 104.25 },
                { tenor: 'RRB', coupon: 1.25, maturity: 'Dec 01, 2031', ytm: 1.85, price: 105.50 }
            ];
            
            // Update date display for sample data
            const dateElement = document.getElementById('data-date');
            if (dateElement) {
                dateElement.textContent = '(sample data)';
            }
            
            populateTable(headers, sampleBondData);
        }
        
        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadBondData();
        });
    </script>
</body>
</html>
